<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>3D META</title>
  <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="keywords" content="meta,facebook,Mark Elliot Zuckerberg">
  <meta name="description" content="meta,facebook,Mark Elliot Zuckerberg">
  <meta name="apple-mobile-web-app-capable" content="yes"  />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="shortcut icon" href="./assets/images/logo.png">
  <link rel="apple-touch-icon" href="./assets/images/logo.png"/>
  <link rel="apple-touch-icon-precomposed" href="./assets/images/logo.png">
  <link rel="Bookmark" href="./assets/images/logo.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    body {
      background: url('./assets/images/bg.png') no-repeat center;
      background-size: cover;
    }
  </style>
</head>

<body>
  <script src="./assets/libs/three.js"></script>
  <script src="./assets/libs/loaders/FBXLoader.js"></script>
  <script src="./assets/libs/inflate.min.js"></script>
  <script src="./assets/libs/OrbitControls.js"></script>
  <script src="./assets/libs/stats.js"></script>
  <script>
    var container, stats, controls;
    var camera, scene, renderer, light, lands = [];
    var clock = new THREE.Clock();
    var mixer, mixerArr = [];
    init();
    animate();
    function init() {
      container = document.createElement('div');
      document.body.appendChild(container);
      // 场景
      scene = new THREE.Scene();
      scene.transparent = true;
      scene.opacity = 0.1;
      scene.fog = new THREE.Fog(0xa0a0a0, 200, 1000);
      // 透视相机：视场、长宽比、近面、远面
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 4, 16);
      camera.lookAt(new THREE.Vector3(0, 0, 0));
      // 半球光源：创建室外效果更加自然的光源
      light = new THREE.HemisphereLight(0xffffff, 0x444444);
      light.position.set(0, 20, 0);
      scene.add(light);
      light = new THREE.DirectionalLight(0xffffff);
      light.position.set(0, 20, 10);
      light.castShadow = true;
      scene.add(light);
      // 环境光
      var ambiColor = '#0C0C0C';
      var ambientLight = new THREE.AmbientLight(ambiColor);
      scene.add(ambientLight);
      // 网格
      var grid = new THREE.GridHelper(100, 100, 0xdddddd, 0xdddddd);
      grid.position.set(0, -10, 0);
      grid.material.opacity = 0.1;
      grid.material.transparent = true;
      scene.add(grid);
      // 加载模型
      var loader = new THREE.FBXLoader();
      var texLoader = new THREE.TextureLoader();
      loader.load('assets/models/meta.fbx', function (mesh) {
        mesh.traverse(function (child) {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
            lands.push(child)
            if (child.name === '球体' || child.name === '球体001') {
              child.visible = false
            }
            if (child.name === '贝塞尔圆') {
              child.material = new THREE.MeshPhysicalMaterial({
                map: texLoader.load("./assets/images/metal.png"),
                metalness: .2,
                transmission: 1,
                roughness: 0.1,
                exposure: 0.4
              })
            }
          }
        });
        mesh.rotation.y = Math.PI / 2;
        mesh.position.set(0, 1, 0);
        mesh.scale.set(0.065, 0.065, 0.065);
        scene.add(mesh);
        mesh.animations.map(item => {
          let animationType = item.name.split('|')[0];
          mesh.traverse(child => {
            if (child.name === animationType && (child.name === '贝塞尔圆')) {
              console.log(child.name)
              let mixer = new THREE.AnimationMixer(child);
              mixerArr.push(mixer);
              let animationClip = item;
              animationClip.duration = 10;
              let clipAction = mixer.clipAction(animationClip).play();
              animationClip = clipAction.getClip();
            }
          })
        })
      });
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearAlpha(0);
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 0, 0);
      controls.update();
      window.addEventListener('resize', onWindowResize, false);
      // stats：初始化性能插件
      stats = new Stats();
      container.appendChild(stats.dom);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.render(scene, camera);
      let time = clock.getDelta();
      mixerArr.map(mixer => {
        mixer && mixer.update(time);
      })
      stats.update();
      requestAnimationFrame(animate);
    }
    // 增加点击事件
    //声明raycaster和mouse变量
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    function onMouseClick(event) {
      // 通过鼠标点击的位置计算出raycaster所需要的点的位置，以屏幕中心为原点，值的范围为-1到1.
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
      // 通过鼠标点的位置和当前相机的矩阵计算出raycaster
      raycaster.setFromCamera(mouse, camera);
      // 获取raycaster直线和所有模型相交的数组集合
      console.log(scene.children)
      let intersects = raycaster.intersectObjects(lands);
      if (intersects.length > 0) {
        let selectedObj = intersects[0].object;
        console.log(intersects[0].object)
      }
    }
    window.addEventListener('click', onMouseClick, false);
  </script>
</body>
</html>